> JPA ê¸°ëŠ¥: ì—”í‹°í‹°ì™€ í…Œì´ë¸”ì„ ë§¤í•‘í•˜ëŠ” ì„¤ê³„ ë¶€ë¶„ / ë§¤í•‘í•œ ì—”í‹°í‹°ë¥¼ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„
ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì—”í‹°í‹°ë¥¼ CRUDí•˜ëŠ” ì—”í‹°í‹°ì™€ ê´€ë ¨ëœ ëª¨ë“  ì¼ì„ ì²˜ë¦¬
> 

# ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì™€ ì—”í‹°í‹° ë§¤ë‹ˆì €

- ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ìƒì„±
    
    `EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");`
    
- ì—”í‹°í‹° ë§¤ë‹ˆì € ìƒì„±
    
    `EntityManager em = emf.createEntityManager();`
    

![image.png](https://velog.velcdn.com/images%2Ftjeong%2Fpost%2F858040b3-5eb5-45ce-b26a-b5399465d526%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-07-18%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%203.14.30.png)

### ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬

- ë§Œë“¤ ë•Œ í•„ìš”í•œ ë¹„ìš©ì´ í¼
    
    â†’ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ëŠ” í•˜ë‚˜ë§Œ ë§Œë“¤ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì—ì„œ ê³µìœ í•˜ë„ë¡ ì„¤ê³„
    
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ë™ì‹œì— ì ‘ê·¼í•´ë„ ì•ˆì „
    
    â†’ ìŠ¤ë ˆë“œ ê°„ ê³µìœ  ê°€ëŠ¥
    

### ì—”í‹°í‹° ë§¤ë‹ˆì €

- ë§Œë“œëŠ”ë° ë¹„ìš©ì´ í¬ì§€ ì•ŠìŒ
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ë™ì‹œì— ì ‘ê·¼í•˜ë©´ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒ
    
    â†’ ìŠ¤ë ˆë“œ ê°„ ê³µìœ  ë¶ˆê°€ëŠ¥
    
- JPA êµ¬í˜„ì²´ë“¤ì€ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ë¥¼ ìƒì„±í•  ë•Œ ì»¤ë„¥ì…˜í’€ë„ ë§Œë“¦ â†’ J2SE í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
- JPAë¥¼ J2EE í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ì œê³µí•˜ëŠ” ë°ì´í„° ì†ŒìŠ¤ ì‚¬ìš©

<aside>

> ### â“ ë™ì‹œì„± ë¬¸ì œ(Concurrency Problem)
> 
> ë™ì‹œì„± ë¬¸ì œëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ë°ì´í„°ì— ì ‘ê·¼í•´ì„œ ë°ì´í„°ë¥¼ ì¡°ì‘í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ
> 
> ```java
> // ìŠ¤ë ˆë“œ 1ì´ ì‹¤í–‰í•˜ëŠ” ì½”ë“œ
> EntityManager em1 = emf.createEntityManager();
> Member member = em1.find(Member.class, 1L);
> member.setName("Kim"); // ì´ë¦„ì„ Kimìœ¼ë¡œ ë³€ê²½
> 
> // ë™ì‹œì— ìŠ¤ë ˆë“œ 2ê°€ ì‹¤í–‰í•˜ëŠ” ì½”ë“œ
> EntityManager em2 = emf.createEntityManager();
> Member sameMember = em2.find(Member.class, 1L);
> member.setName("Park"); // ì´ë¦„ì„ Parkìœ¼ë¡œ ë³€ê²½
> ```
> 
> ë¬¸ì œ
> 
> 1. ë°ì´í„° ë¶ˆì¼ì¹˜
> - ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ê³  í•  ë•Œ, ë§ˆì§€ë§‰ì— ìˆ˜ì •í•œ ë‚´ìš©ë§Œ ë‚¨ê³  ì´ì „ ìˆ˜ì •ì‚¬í•­ì´ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŒ
> 2. ë°ì´í„° ì¼ê´€ì„± ê¹¨ì§
> - í•œ ìŠ¤ë ˆë“œê°€ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ì¤‘ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì¤‘ê°„ ìƒíƒœì˜ ë°ì´í„°ë¥¼ ì½ì–´ê°€ëŠ” ê²½ìš°, ë°ì´í„°ì˜ ì¼ê´€ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ
> 
> í•´ê²°
> 
> 1. ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ìŠ¤ë ˆë“œ ê°„ì— ì ˆëŒ€ ê³µìœ  ê¸ˆì§€
>     - ê° ìŠ¤ë ˆë“œë§ˆë‹¤ ë³„ë„ì˜ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©
> 2. íŠ¸ëœì­ì…˜ì„ ì ì ˆíˆ ì‚¬ìš©
>     - @Transactional ì–´ë…¸í…Œì´ì…˜ í™œìš©
>     - ëª…ì‹œì ì¸ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
> 3. JPAê°€ ì œê³µí•˜ëŠ” ë½í‚¹(Locking) ë©”ì»¤ë‹ˆì¦˜ ì‚¬ìš©
>     - ë‚™ê´€ì  ë½(Optimistic Lock)
>     - ë¹„ê´€ì  ë½(Pessimistic Lock)

</aside>

<aside>

> ### â“ JPAì˜ ë½í‚¹ ë©”ì»¤ë‹ˆì¦˜
> 
> 1. **ë‚™ê´€ì  ë½(Optimistic Lock) â†’ ì¶©ëŒì´ ì ì€ ê²½ìš°**
>     - ë°ì´í„° ì¶©ëŒì´ ë°œìƒí•˜ì§€ ì•Šì„ ê²ƒì´ë¼ê³  ë‚™ê´€ì ìœ¼ë¡œ ê°€ì •
>     - ë²„ì „(version) ì»¬ëŸ¼ì„ ì‚¬ìš©í•˜ì—¬ ì¶©ëŒì„ ê°ì§€
>     - ì‹¤ì œ DBì— ë½ì„ ê±¸ì§€ ì•ŠìŒ
>     
>     ```java
>     @Entity
>     public class Member {
>         @Id
>         private Long id;
>         
>         private String name;
>         
>         @Version    // ë²„ì „ ê´€ë¦¬ìš© í•„ë“œ
>         private Long version;
>     }
>     ```
>     
>     - ë™ì‘
>         1. ë°ì´í„°ë¥¼ ì½ì„ ë•Œ ë²„ì „ ì •ë³´ë„ í•¨ê»˜ ì½ìŒ
>         2. ë°ì´í„° ìˆ˜ì • ì‹œ ë²„ì „ë„ í•¨ê»˜ ì¦ê°€
>         3. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¨¼ì € ìˆ˜ì •í–ˆë‹¤ë©´ ë²„ì „ì´ ë‹¬ë¼ì ¸ì„œ ì¶©ëŒ ê°ì§€
>     - ì¥ì : ë°ì´í„°ë² ì´ìŠ¤ ë½ì´ ì—†ì–´ ì„±ëŠ¥ì´ ì¢‹ìŒ
>     - ë‹¨ì : ì¶©ëŒ ì‹œ ì¬ì‹œë„ ë¡œì§ì„ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•¨
> 2. **ë¹„ê´€ì  ë½(Pessimistic Lock) â†’ ì¶©ëŒì´ ìì£¼ ì¼ì–´ë‚˜ëŠ” ê²½ìš°**
>     - ë°ì´í„° ì¶©ëŒì´ ë°œìƒí•  ê²ƒì´ë¼ê³  ë¹„ê´€ì ìœ¼ë¡œ ê°€ì •
>     - ë°ì´í„°ë² ì´ìŠ¤ì˜ ë½ ê¸°ëŠ¥ì„ ì‚¬ìš©
>     - ì‹¤ì œ DBì— ë½ì„ ê²€
>     
>     ```java
>     // ë¹„ê´€ì  ë½ì„ ì‚¬ìš©í•œ ë°ì´í„° ì¡°íšŒ
>     @Lock(LockModeType.PESSIMISTIC_WRITE)
>     @Query("select m from Member m where m.id = :id")
>     Member findByIdWithPessimisticLock(@Param("id") Long id);
>     ```
>     
>     - ì¥ì : í™•ì‹¤í•œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
>     - ë‹¨ì : ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
> 3. **ì‹¤ì œ ì‚¬ìš©**
>     - ê¸°ë³¸ì ìœ¼ë¡œëŠ” ë‚™ê´€ì  ë½ì„ ì‚¬ìš©
>     - ëˆ ê´€ë ¨ ì¤‘ìš” ë°ì´í„°ëŠ” ë¹„ê´€ì  ë½ ê³ ë ¤
>     - í•„ìš”í•œ ë¶€ë¶„ì—ë§Œ ì„ ë³„ì ìœ¼ë¡œ ë½ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
>     - 
</aside>

<aside>

> ### â“ J2SE vs J2EE
> 
> 1. J2SE(Java 2 Standard Edition, Java SE)
>     - ê¸°ë³¸ì ì¸ ìë°” ê°œë°œ í™˜ê²½ì„ ì œê³µ
>     - í•µì‹¬ ê¸°ëŠ¥ë“¤ë§Œ í¬í•¨ (ìë°”ì˜ ê¸°ë³¸)
>         - ê¸°ë³¸ ìë£Œêµ¬ì¡°
>         - ì…ì¶œë ¥
>         - ë„¤íŠ¸ì›Œí‚¹
>         - GUI ê°œë°œ(Swing)
>     - ë‹¨ë… ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì— ì‚¬ìš©
>     - ì˜ˆ: ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜
> 2. J2EE(Java 2 Enterprise Edition, Jakarta EE)
>     - J2SEë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥ëœ ê¸°ì—…ìš© ê°œë°œ í™˜ê²½
>     - ëŒ€ê·œëª¨ ê¸°ì—…ìš© ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì— í•„ìš”í•œ ê¸°ëŠ¥ë“¤ í¬í•¨:
>         - ì›¹ ì„œë²„ ê¸°ëŠ¥ (Servlet, JSP)
>         - ë¶„ì‚° íŠ¸ëœì­ì…˜
>         - EJB(Enterprise JavaBeans)
>         - JPA(Java Persistence API)
>         - ë©”ì‹œì§• ì„œë¹„ìŠ¤
>     - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ ê¸°ì—…ìš© ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì— ì‚¬ìš©
>     - Springê³¼ ê°™ì€ í”„ë ˆì„ì›Œí¬ì˜ ë“±ì¥ìœ¼ë¡œ Jakarta EEì˜ ì¼ë¶€ ê¸°ëŠ¥ë“¤ì€ ëœ ì‚¬ìš©ë˜ëŠ” ì¶”ì„¸

</aside>

<aside>


> ### â“ Spring í”„ë ˆì„ì›Œí¬ì˜ ë“±ì¥ìœ¼ë¡œ Jakarta EEì˜ ì‚¬ìš©ì´ ì¤„ì–´ë“  ì´ìœ 
> 
> 1. **ë³µì¡ì„±**
>     - Jakarta EE
>         - ë§¤ìš° ë¬´ê²ê³  ë³µì¡í•œ ìŠ¤í™
>     - Spring
>         - ë” ê°€ë³ê³  ìœ ì—°í•œ êµ¬ì¡°ë¥¼ ì œê³µ
>             - í•„ìš”í•œ ë¶€ë¶„ë§Œ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©
>             - ì„¤ì •ì´ ë” ê°„ë‹¨
> 2. **ê°œë°œ ìƒì‚°ì„±**
>     - Jakarta EE
>         - EJBì™€ ê°™ì€ ë¬´ê±°ìš´ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
>         - ë§ì€ ì„¤ì • íŒŒì¼ í•„ìš”
>         - ë°°í¬ê°€ ë³µì¡í•¨
>     - Spring
>         - POJO(Plain Old Java Object) ê¸°ë°˜ ê°œë°œ
>         - ì• ë…¸í…Œì´ì…˜ ê¸°ë°˜ì˜ ê°„ë‹¨í•œ ì„¤ì •
>         - Spring Bootì˜ ë“±ì¥ìœ¼ë¡œ ì„¤ì •ì´ ë”ìš± ê°„ì†Œí™”
> 
> ```java
> // EJB ë°©ì‹ (Jakarta EE)
> @Stateless
> public class UserServiceEJB {
>     @PersistenceContext
>     private EntityManager em;
>     // ...
> }
> 
> // Spring ë°©ì‹
> @Service
> public class UserService {
>     @Autowired
>     private UserRepository userRepository;
>     // ...
> }
> ```
> 
> - Jakarta EEì˜ ì¼ë¶€ ìŠ¤í™ì€ ì—¬ì „íˆ ë§ì´ ì‚¬ìš©
>     - JPA: ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬
>     - Servlet: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ëŠ¥
>     - Bean Validation: ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
>     - JTA: íŠ¸ëœì­ì…˜ ê´€ë¦¬
> - Springì´ Java ê°œë°œì˜ ì‚¬ì‹¤ìƒ í‘œì¤€

</aside>

<aside>

> ### â“ Spring vs Spring Boot
> 
> 1. **Spring Framework**
>     - 2003ë…„ì— ì²˜ìŒ ì¶œì‹œëœ ìë°” ê¸°ë°˜ì˜ í”„ë ˆì„ì›Œí¬
>     - í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ ì œê³µ:
>         - ì˜ì¡´ì„± ì£¼ì…(DI)
>         - AOP(ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°)
>         - íŠ¸ëœì­ì…˜ ê´€ë¦¬
>         - MVC íŒ¨í„´ ë“±
>     - ì„¤ì •ì´ ë³µì¡í•˜ê³  ì´ˆê¸° ì„¸íŒ…ì— ì‹œê°„ì´ ë§ì´ ê±¸ë¦¼
> 2. **Spring Boot**
>     - 2014ë…„ì— ì¶œì‹œëœ Spring Frameworkì˜ í™•ì¥íŒ
>     - Spring Frameworkë¥¼ ë” ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë„êµ¬
>     - ì£¼ìš” íŠ¹ì§•:
>         - ìë™ ì„¤ì •(Auto Configuration)
>         - ë‚´ì¥ ì„œë²„(Tomcat, Jetty ë“±) ì œê³µ
>         - starter ì¢…ì†ì„±ìœ¼ë¡œ ì‰¬ìš´ ì˜ì¡´ì„± ê´€ë¦¬
>         - ë³„ë„ì˜ ì„¤ì • ì—†ì´ë„ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥

</aside>

# ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(persistence context)

- ì—”í‹°í‹°ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½
- ì—”í‹°í‹° ë§¤ë‹ˆì €ë¡œ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê±°ë‚˜ ì¡°íšŒí•˜ë©´ ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ë¥¼ ë³´ê´€í•˜ê³  ê´€ë¦¬
- em.persist(member);
    
    â†’ persist() ë©”ì„œë“œëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•´ member ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥
    

# ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°

- ë¹„ì˜ì†(new): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ê´€ê³„ì—†ëŠ” ìƒíƒœ
- ì˜ì†(managed): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ
- ì¤€ì˜ì†(detached): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœ
- ì‚­ì œ(removed): ì‚­ì œëœ ìƒíƒœ

![image.png](https://velog.velcdn.com/images%2Ftjeong%2Fpost%2F1da1d9b3-9561-4810-98de-903555ef631a%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-07-18%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%203.28.08.png)

### ë¹„ì˜ì†

- ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒì„±í–ˆì§€ë§Œ, ì•„ì§ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì§€ ì•Šì€ ìƒíƒœ
- JPAê°€ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ìƒíƒœ

```java
Member member = new Member(); // ìƒˆë¡œìš´ ê°ì²´ ìƒì„±
member.setId(1L);
member.setName("í™ê¸¸ë™");
// ì´ ìƒíƒœì—ì„œëŠ” JPAì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ìŒ
```

### ì˜ì†

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœ

```java
// persist() ì‚¬ìš©
em.persist(member);

// find() ì‚¬ìš©
Member member = em.find(Member.class, 1L);

// JPQL ì‚¬ìš©
List<Member> members = em.createQuery("select m from Member m", Member.class)
                        .getResultList();
```

### ì¤€ì˜ì†

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

```java
// detach() : íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ
em.detach(member);

// clear() : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”
em.clear();

// close() : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ
em.close();
```

### ì‚­ì œ

- ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œí•œ ìƒíƒœ

```java
em.remove(member); // ì—”í‹°í‹° ì‚­ì œ
```

# ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ íŠ¹ì§•

> ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì—”í‹°í‹°ë¥¼ ì‹ë³„ìë¡œ êµ¬ë¶„ â†’ ë°˜ë“œì‹œ ì‹ë³„ìê°€ ìˆì–´ì•¼ í•œë‹¤
í”ŒëŸ¬ì‹œ: JPAëŠ” íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ëŠ” ìˆœê°„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìƒˆë¡œ ì –ì•„ëœ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜
> 
1. 1ì°¨ ìºì‹œ
2. ë™ì¼ì„± ë³´ì¥
3. ì“°ê¸° ì§€ì—°
4. ë³€ê²½ ê°ì§€
5. ì§€ì—° ë¡œë”©

## ì—”í‹°í‹° ì¡°íšŒ

### **1ì°¨ ìºì‹œ**

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— ìˆëŠ” ìºì‹œ
    
    â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— Map ì¡´ì¬, key = ì‹ë³„ì / value = ì—”í‹°í‹° ì¸ìŠ¤í„´ìŠ¤
    
- ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì „ì— 1ì°¨ ìºì‹œë¥¼ ë¨¼ì € í™•ì¸

### ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ

- ì¡°íšŒí•œ ì—”í‹°í‹°ê°€ 1ì°¨ ìºì‹œì— ì—†ë‹¤ë©´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•´ ì—”í‹°í‹° ìƒì„±
- 1ì°¨ ìºì‹œì— ì €ì¥í•œ í›„ ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹° ë°˜í™˜
- ì˜ì† ì—”í‹°í‹°ì˜ **ë™ì¼ì„± ë³´ì¥**

```java
// ì²« ì¡°íšŒ: DBì—ì„œ ì¡°íšŒ
Member member1 = em.find(Member.class, 1L);
// ë‘ë²ˆì§¸ ì¡°íšŒ: 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
Member member2 = em.find(Member.class, 1L);

System.out.println(member1 == member2);
//true
```

![image.png](https://blog.kakaocdn.net/dn/cJmWfd/btqygSKfaqr/Xy9D94SZ4xuSh3SJRv4lM1/img.png)

## ì—”í‹°í‹° ë“±ë¡

```java
EntityManager em = emf.createEntityManager();
EntityTransaction transactioon = em.getTransaction();

//ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ë°ì´í„°ë¥¼ ë³€ê²½í•  ë•Œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•´ì•¼í•¨
transactioon.begin();

em.persist(memberA);
em.persist(memberB);
//ì•„ì§ì€ INSERT SQLì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë³´ë‚´ì§€ ì•Šì€ ìƒíƒœ

//ì»¤ë°‹ì„ í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— INSERT SQLì„ ë³´ëƒ„
transactioon.commit();
```

- ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ê¹Œì§€ ë‚´ë¶€ ì¿¼ë¦¬ ì €ì¥ì†Œì— INSERT SQLì„ ì €ì¥
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ì¿¼ë¦¬ ì €ì¥ì†Œì— ì €ì¥í•œ ì¿¼ë¦¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ëƒ„ â†’ **ì“°ê¸° ì§€ì—°**

![image.png](https://velog.velcdn.com/images%2Ftjeong%2Fpost%2F9d39ca95-805b-4199-986e-7997d6b7b2d7%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-07-18%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.31.43.png)

- persist()ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ë„ ì»¤ë°‹ ì „ê¹Œì§€ëŠ” ì—”í‹°í‹°ëŠ” 1ì°¨ ìºì‹œì—, INSERT SQLì€ ë‚´ë¶€ ì¿¼ë¦¬ ì €ì¥ì†Œì— ì €ì¥

![image.png](https://velog.velcdn.com/images%2Ftjeong%2Fpost%2F47194abb-a1ee-4258-bbef-6f35212bce00%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-07-18%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.36.15.png)

- íŠ¸ëœì­ì…˜ ì»¤ë°‹ì„ í•˜ë©´ ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í”ŒëŸ¬ì‹œ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë™ê¸°í™”í•œ í›„ ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹

<aside>

> ### ğŸ’¡ í”ŒëŸ¬ì‹œ(Flush)
> 
> ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•˜ëŠ” ì‘ì—…
> 
> 1. í”ŒëŸ¬ì‹œ ë™ì‘
>     - ë³€ê²½ ê°ì§€(Dirty Checking)ê°€ ë™ì‘í•´ì„œ ìˆ˜ì •ëœ ì—”í‹°í‹°ë¥¼ ì°¾ìŒ
>     - ìˆ˜ì •ëœ ì—”í‹°í‹°ëŠ” UPDATE SQLì„ ìƒì„±í•´ì„œ ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì— ë“±ë¡
>     - ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì˜ ì¿¼ë¦¬ë“¤ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡
> 2. í”ŒëŸ¬ì‹œê°€ ë°œìƒí•˜ëŠ” ì‹œì 
>     
>     ```java
>     // 1. ì§ì ‘ í˜¸ì¶œ
>     em.flush(); 
>     
>     // 2. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ìë™ í˜¸ì¶œ
>     transaction.commit();
>     
>     // 3. JPQL ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ìë™ í˜¸ì¶œ
>     query = em.createQuery("select m from Member m");
>     ```
>     
> 3. íŠ¹ì§•
>     - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¹„ìš°ì§€ ì•ŠìŒ
>     - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë™ê¸°í™”
>     - íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ì‘ì—… ë‹¨ìœ„ê°€ ì¤‘ìš” -> ì»¤ë°‹ ì§ì „ì—ë§Œ ë™ê¸°í™” í•˜ë©´ ë¨
>     - find() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•ŒëŠ” í”ŒëŸ¬ì‹œê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
> 4. í”ŒëŸ¬ì‹œ ëª¨ë“œ ì˜µì…˜
>     - ì—”í‹°í‹° ë§¤ë‹ˆì €ì— í”ŒëŸ¬ì‹œ ëª¨ë“œë¥¼ ì§ì ‘ ì§€ì •í•˜ë ¤ë©´ javax.persistence.FlushModeType ì‚¬ìš©
>     - FlushModeType.AUTO : ì»¤ë°‹ì´ë‚˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ í”ŒëŸ¬ì‹œ(ê¸°ë³¸ê°’)
>     - FlushModeType.COMMIT : ì»¤ë°‹í•  ë•Œë§Œ í”ŒëŸ¬ì‹œ

</aside>

## ì—”í‹°í‹° ìˆ˜ì •

- SQLë¬¸ì„ ì§ì ‘ ë‹¤ë£¬ë‹¤ë©´ ìˆ˜ì •ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ SQLë¬¸ì„ ì¶”ê°€ë¡œ ì‘ì„±í•´ì¤˜ì•¼í•¨
    
    â†’ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ SQLì— ì˜ì¡´ì , ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³µì¡ì„± ì¦ê°€
    
- JPAë¡œ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•ŒëŠ” ë‹¨ìˆœíˆ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ë°ì´í„°ë§Œ ë³€ê²½

<aside>

> ### ğŸ’¡ ë³€ê²½ ê°ì§€(**dirty checking)**
> 
> - JPAëŠ” ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë³´ê´€í•  ë•Œ ìµœì´ˆ ìƒíƒœë¥¼ ë³µì‚¬í•´ ì €ì¥í•´ë‘  â†’ ìŠ¤ëƒ…ìƒ·
> - í”ŒëŸ¬ì‹œ ì‹œì ì— ìŠ¤ëƒ…ìƒ·ê³¼ ì—”í‹°í‹°ë¥¼ ë¹„êµí•´ ë³€ê²½ëœ ì—”í‹°í‹° ì°¾ìŒ
> - ë™ì‘
>     1. íŠ¸ëœì­ì…˜ ì»¤ë°‹
>     2. ì—”í‹°í‹° ë§¤ë‹ˆì € ë‚´ë¶€ì—ì„œ í”ŒëŸ¬ì‹œ í˜¸ì¶œ
>     3. ì¸í…Œí‹°ì™€ ìŠ¤ëƒ…ìƒ· ë¹„êµ â†’ ë³€ê²½ëœ ì—”í‹°í‹° ì°¾ìŒ
>     4. ë³€ê²½ëœ ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ìˆ˜ì • ì¿¼ë¦¬ ìƒì„±
>     5. ìˆ˜ì • ì¿¼ë¦¬ ì“°ê¸° ì§€ì—° ì¿¼ë¦¬ ì €ì¥ì†Œì— ì €ì¥
>     6. ì“°ê¸° ì§€ì—° ì¿¼ë¦¬ ì €ì¥ì†Œì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì „ë‹¬
>     7. ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ì»¤ë°‹
> - ë³€ê²½ ê°ì§€ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ëŠ” ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ì—ë§Œ ì ìš©
> - JPAì˜ ê¸°ë³¸ ì „ëµì€ ëª¨ë“  í•„ë“œ ì—…ë°ì´íŠ¸

<aside>

>  **â“ ëª¨ë“  í•„ë“œ ì—…ë°ì´íŠ¸ì˜ ì¥ì **
> 
> - ëª¨ë“  í•„ë“œë¥¼ ì‚¬ìš©í•˜ë©´ ìˆ˜ì • ì¿¼ë¦¬ê°€ í•­ìƒ ê°™ìŒ
>     
>     â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ë¯¸ë¦¬ ìƒì„±í•˜ê³  ì¬ì‚¬ìš© ê°€ëŠ¥
>     
> - ë°ì´í„°ë² ì´ìŠ¤ì— ë™ì¼í•œ ì¿¼ë¦¬ë¥¼ ë³´ë‚´ë©´ ì´ë¯¸ íŒŒì‹±ëœ ì¿¼ë¦¬ë¼ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

</aside>

</aside>

![image.png](https://velog.velcdn.com/images%2Ftjeong%2Fpost%2F97ee4754-20f9-497c-a818-dadac42f6574%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-07-18%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%2010.49.19.png)

## ì—”í‹°í‹° ì‚­ì œ

- ì—”í‹°í‹°ë¥¼ ì‚­ì œí•˜ê¸° ìœ„í•´ì„  ëŒ€ìƒì„ ë¨¼ì € ì¡°íšŒ

```java
// ì‚­ì œ ëŒ€ìƒ ì—”í‹°í‹° ì¡°íšŒ
Memeber memberA = em.find(Member.class, "memberA");
//ì—”í‹°í‹° ì‚­ì œ
em.remove(memberA);
```

- ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚´ë¶€ ì¿¼ë¦¬ ì €ì¥ì†Œì— ì €ì¥í•œ í›„ ì»¤ë°‹ ì‹œ ë°˜ì˜
- em.remove(memberA)ë¥¼ í˜¸ì¶œí•˜ë©´  memberAëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±°

# ì¤€ì˜ì†

- ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë¶„ë¦¬ëœ ìƒíƒœ
    
    â†’ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œì˜¥í•˜ëŠ” ê¸°ëŠ¥ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
    
- íŠ¹ì§•
    - ë¹„ì˜ì† ìƒíƒœì— ê°€ê¹ì›€
    - ì‹ë³„ì ê°’ì„ ê°–ê³ ìˆìŒ
    - ì§€ì—°ë¡œë”©í•  ìˆ˜ ì—†ìŒ
    
    <aside>
    
    > ### ğŸ’¡ ì¤€ì˜ì† vs ë¹„ì˜ì†
    > 
    > **ë¹„ì˜ì†(new/transient) ìƒíƒœ**
    > 
    > - ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒˆë¡œ ìƒì„±í–ˆì§€ë§Œ, ì•„ì§ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒíƒœ
    > - JPAê°€ ì „í˜€ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ìƒíƒœ
    > - ë‹¨ìˆœíˆ ìë°” ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ
    > 
    > ```java
    > Member member = new Member(); // ë¹„ì˜ì† ìƒíƒœ
    > member.setId(1L);
    > member.setName("user1");
    > ```
    > 
    > **ì¤€ì˜ì†(detached) ìƒíƒœ**
    > 
    > - í•œë²ˆ ì˜ì† ìƒíƒœì˜€ë‹¤ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœ
    > - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥(ë³€ê²½ ê°ì§€ ë“±)ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
    > - ì‹ë³„ì ê°’ì„ ê°€ì§€ê³  ìˆìŒ (ì´ë¯¸ í•œë²ˆ ì˜ì† ìƒíƒœì˜€ê¸° ë•Œë¬¸)
    > 
    > ```java
    > // ì˜ì† ìƒíƒœ
    > Member member = em.find(Member.class, 1L);
    > 
    > // ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
    > em.detach(member); // íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
    > em.clear();        // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”
    > em.close();        // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ
    > ```
    > 
    > **ì°¨ì´ì **
    > 
    > 1. ì‹ë³„ì ê°’
    >     - ë¹„ì˜ì†: ì‹ë³„ì ê°’ì´ ì—†ì„ ìˆ˜ ìˆìŒ
    >     - ì¤€ì˜ì†: ë°˜ë“œì‹œ ì‹ë³„ì ê°’ì´ ìˆìŒ
    > 2. ì´ì „ ì˜ì† ìƒíƒœ ê²½í—˜
    >     - ë¹„ì˜ì†: ì˜ì† ìƒíƒœì˜€ë˜ ì ì´ ì—†ìŒ
    >     - ì¤€ì˜ì†: í•œë²ˆì´ë¼ë„ ì˜ì† ìƒíƒœì˜€ìŒ
    >         
    >         â†’ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ëŠ” ì´ì „ì— ì˜ì†í™”ëœ ì ì´ ìˆì–´ ë°ì´í„°ì˜ ì¼ê´€ì„±ì´ë‚˜ ìœ íš¨ì„±ì´ ì–´ëŠì •ë„ ë³´ì¥ë¨
    >         
    > 3. ë°ì´í„°ë² ì´ìŠ¤ ê´€ê³„
    >     - ë¹„ì˜ì†: DBì™€ ë§¤í•‘ëœ ì ì´ ì—†ìŒ
    >     - ì¤€ì˜ì†: DBì— ë°ì´í„°ê°€ ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
    >     - 
    </aside>
    
- ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“œëŠ” ë°©ë²•
    - em.detach(entity);
    - em.clear();
    - em.close();

### detach(): íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜

```java
public void testDetached() { 
...
//íšŒì› ì—”í‹°í‹° ìƒì„±, ë¹„ì˜ì† ìƒíƒœ 
Member member = new Member(); 
member.setId("memberA"); 
member.setUsername("íšŒì›A");

//íšŒì› ì—”í‹°í‹° ì˜ì† ìƒíƒœ 
em.persist(member);

//íšŒì› ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬, ì¤€ì˜ì† ìƒíƒœ 
em.detach(member);

//íŠ¸ëœì­ì…˜ ì»¤ë°‹
transaction.commit();
}
```

- em.detach(member) í˜¸ì¶œ: í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ì§€ ë§ë¼ëŠ” ëœ»
    
    â†’ 1ì°¨ ìºì‹œ, ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œ ë“± ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ëª¨ë“  ì •ë³´ê°€ ì œê±°ë¨
    

### clear(): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•´ í•´ë‹¹ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ëª¨ë“  ì—”í‹°í‹°ë¥¼ ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“¦

```java
public void testClear() { 
...
//ì—”í‹°í‹° ì¡°íšŒ(ì˜ì† ìƒíƒœ)
Member member = em.find(Member.class, "memberA");

//ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
em.clear();

//ì¤€ì˜ì† ìƒíƒœ
member.setUsername("changedName");
//ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ë³€ê²½ê°ì§€ê°€ ë™ì‘í•˜ì§€ ì•Šì•„ ë³€ê²½ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ
}
```

### close(): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ í™œë™ì„ ì¢…ë£Œí•´ ëª¨ë“  ì—”í‹°í‹°ê°€ ì¤€ì˜ì† ìƒíƒœê°€ ë¨

```java
public void testClose() {
	...
	//ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ
	em.close();
}
```

## merge(): ë³‘í•©

- ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½
- ì •ë³´ë¥¼ ë°›ì•„ì™€ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ë°˜í™˜

```java
public class ExamMergeMain {
    static EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");

    public static void main(String args[]) {

        Member member = createMember("memberA", "íšŒì›1");

        member.setUsername("íšŒì›ëª…ë³€ê²½");

        mergeMember(member);
    }

    static Member createMember(String id, String username) {
		    //ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ 1 ì‹œì‘
        EntityManager em1 = emf.createEntityManager();
        EntityTransaction tx1 = em1.getTransaction();
				//íŠ¸ëœì ì…˜ ì‹œì‘
        tx1.begin();
        
        //ì—”í‹°í‹° ìƒì„±(ë¹„ì˜ì†)
        Member member = new Member();
        member.setId(id);
        member.setUsername(username);
        em1.persist(member);
        //íŠ¸ëœì ì…˜ ì»¤ë°‹(ì˜ì†)
        tx1.commit();
        
        //ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸1 ì¢…ë£Œ(ì¤€ì˜ì†)
        em1.close();

        return member;
    }

    static void mergeMember(Member member) {
				//ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸2 ì‹œì‘
				//ì—”í‹°í‹° memberëŠ” ì¤€ì˜ì† ìƒíƒœ
        EntityManager em2 = emf.createEntityManager();
        EntityTransaction tx2 = em2.getTransaction();
        //íŠ¸ëœì ì…˜ ì‹œì‘
        tx2.begin();
        
        //memberëŠ” ê³„ì† ì¤€ì˜ì† ìƒíƒœ
        //mergeMemberëŠ” ìƒˆë¡œìš´ ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°
        Member mergeMember = em2.merge(member);
        
        tx2.commit();

        System.out.println("member = " + member.getUsername());
        //member = íšŒì›ëª…ë³€ê²½: ì¤€ì˜ì† ìƒíƒœì§€ë§Œ ê°ì²´ì˜ ê°’ì€ ë³€ê²½ëœ ìƒíƒœ ìœ ì§€
        System.out.println("mergeMember = " + mergeMember.getUsername());
        //mergeMember = íšŒì›ëª…ë³€ê²½
        System.out.println("em2 contains member = " + em2.contains(member));
        //em2 contains member = false: ì¤€ì˜ì† ìƒíƒœì˜ memberëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ì§€ ì•ŠìŒ
        System.out.println("em2 contains mergeMember = " + em2.contains(mergeMember));
        //em2 contains mergeMember = true: merge()ë¡œ ìƒì„±ëœ mergeMemberëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬
        System.out.println("mergeMember.equals(member) = " +  mergeMember.equals(member));
        //mergeMember.equals(member) = false: ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤, ë‹¤ë¥¸ ê°ì²´ì„

				//mergeMemberë„ ì¤€ì˜ì† ìƒíƒœê°€ ë¨
        em2.close();
    }

}
```

![image.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FmeCYx%2FbtrM6bA5lgZ%2FihOhmTWokn7ypU06vHRSA1%2Fimg.png)

### ì¤€ì˜ì† ë³‘í•© ë™ì‘ ê³¼ì •

1. ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¡°íšŒ
2.  1ì°¨ ìºì‹œì—ì„œ ì—”í‹°í‹°ë¥¼ ì°¾ìŒ
3. 1ì°¨ ìºì‹œì— ì—†ìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ
4. ì˜ì† ì—”í‹°í‹°ê°€ ì—†ëŠ” ê²½ìš° - ìƒˆë¡œìš´ ì—”í‹°í‹° ìƒì„± (INSERT)
    1. ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹°ë¥¼ ìƒì„±
    2. ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹°ì— ë³µì‚¬
    3. ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥
    4. ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹°ë¥¼ ë°˜í™˜
5. ì˜ì† ì—”í‹°í‹°ê°€ ìˆëŠ” ê²½ìš° - ë°ì´í„° ë³‘í•© ìˆ˜í–‰ (UPDATE)
    1. ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ì˜ì† ì—”í‹°í‹°ì— ë³µì‚¬
    2. ì˜ì† ì—”í‹°í‹°ë¥¼ ë°˜í™˜

```java
// 1. memberAë¼ëŠ” IDë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
Member mergeMember = em.merge(member);

// 2-1. ì˜ì† ì—”í‹°í‹°ê°€ ì—†ëŠ” ê²½ìš°
Member newMember = new Member();
newMember.setId(member.getId());
newMember.setUsername(member.getUsername());
// ... ëª¨ë“  í•„ë“œ ë³µì‚¬

// 2-2. ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥
em.persist(newMember);
return newMember;
```

```java
// 1. memberAë¼ëŠ” IDë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
Member mergeMember = em.merge(member);

// 2. ê¸°ì¡´ ì˜ì† ì—”í‹°í‹°ì— ë°ì´í„° ë³µì‚¬
mergeMember.setUsername(member.getUsername());
// ... ëª¨ë“  í•„ë“œ ë³µì‚¬

// 3. ì´ë¯¸ ì˜ì† ìƒíƒœì´ë¯€ë¡œ ë³„ë„ì˜ persist í•„ìš” ì—†ìŒ
return mergeMember;
```

### ë¹„ì˜ì† ë³‘í•© ë™ì‘ ê³¼ì •

1. ë¹„ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¡°íšŒ(ì‹ë³„ìê°€ ì—†ìœ¼ë©´ 3ë²ˆìœ¼ë¡œ)
2. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ ì¡°íšŒ
3. ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ ìƒì„±
4. ë¹„ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ìƒˆë¡œìš´ ì—”í‹°í‹°ì— ë³µì‚¬
5. ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥(ì˜ì† ìƒíƒœ)
6. ìƒˆë¡œìš´ ì˜ì† ì—”í‹°í‹° ë°˜í™˜

```java
// ë¹„ì˜ì† ì—”í‹°í‹° ìƒì„±
Member member = new Member();
member.setId("id1");
member.setUsername("íšŒì›1");

// ë¹„ì˜ì† ë³‘í•©
Member newMember = em.merge(member);  // INSERT ì¿¼ë¦¬ ì‹¤í–‰
```
